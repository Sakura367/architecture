### RDB方式
RDB方式的持久化是通过"快照"完成的，当符合一定条件时，Redis都会将内存中所有数据生成一份副本保存在硬盘上，这个过程即为“快照”。Redis默认将快照文件存储在Redis当前进程的工作目录中的dump.rdb文件中，可以通过dir和bfilename指定路径和文件名。Redis会在以下几种情况下对数据进行快照：
- 根据配置文件中设置的配置进行自动快照；
- 用户执行SAVE或BGSAVE命令；
- 执行FLUSHALL命令
- 进行主从复制时

#### 原理
快照执行的基本思想如下：
- Redis使用fork函数复制当前进程（父进程）的副本（子进程）
- 父进程继续响应客户端请求，子进程开始讲内存中数据写入快照文件中。
- 当子进程写入完所有数据后，会用该临时文件替换旧的RDB文件，完成快照。

在执行fork函数时，是异步操作，也就是说fork函数发生的那一刻父子进程会共享同一内存数据，当父进程修改其中谋片数据库时（如执行一个写命令），操作系统会将该片数据复制一份以保证子进程的快照操作不受影响，这就意味着， 在执行快照命令之后的数据更新，并不会同步更新到快照文件中，RDB文件存储的就是执行fork函数那一刻的内存数据。

同时，从以上描述可以得知，在执行快照期间，发生写数据，复制的只是更新数据的那一片区的数据，并不是全部数据，这就意味着执行fork内存后，内存的使用量并不会翻倍。但是同时我们需要将系统的设置为，允许应用程序申请超过可用内存。在/etc/sysctl.conf文件中加入vm.overcommit_memory = 1，然后重启系统确保生效。

**优点**
- 文件时刻都是完整的，不会存在文件不完整的情况，这个特点非常有利于数据保存。
- 文件经过压缩，非常适合用来存储和传输数据。
- 从硬盘加载文件到内存时，效率也很高。

**缺点**
- 一旦Redis异常退回，就会丢失最后一次快照以后更新的数据。


### AOF方式
如果对数据丢失率有较高的要求，会开启AOF持久化来降低数据丢失。AOF会将Redis执行的每一条写命令追加到文件中，但是这一过程显然会降低Redis性能。

开启AOF之后，每执行一条写命令，Redis就会将该命令写入AOF文件中，AOF文件的默认存储位置和RDB文件的位置相同，通过dir和appendfilename来指定路径和文件名，默认文件名为appendonly.aof。

#### AOF数据持久化
每次执行写操作，AOF都会将命令记录在AOF文件中，但是事实上，由于操作系统缓存机制，数据并没有马上写入硬盘，而是写在了硬盘缓存，默认情况下，会每隔30s执行一次同步操作，将硬盘缓存中的数据持久化，如果在此期间断电，就会丢失数据，一般开启AOF的应用都无法忍受长达30s的数据丢失，因此我们需要通过配置appendfsync参数来设置同步时间：
```
appendfsyn always
appendfsyn everysec
appendfsyn no
```

#### AOF重写
- auto-aof-rewrite-percentage 参数的意义为当前aof文件大小超过上一次重写时的百分之100会进行再次重写，如果初次重写，则以启动时的AOF文件大小为依据。
- auto-aof-rewrite-min-size 限制了允许重写的最小AOF文件大小，通常AOF文件很小的情况下也没有必要重写。
- 通过BGREWRITEAOF命令手动执行AOF重写。

AOF重写是新的AOF文件替换旧的AOF文件的功能，实际上AOF文件重写并不会对现有的AOF文件做任何读取、分析和写入操作，这个功能是通过读取服务器当前的数据库状态来实现的。

##### AOF后台重写
Redis如果启动了AOF持久化功能，则会将AOF重写程序放在子进程里执行。
- 在子进程进行AOF重写期间，服务器进程（父进程）可以继续处理客户端请求
- 子进程带有服务器进程的数据副本，使用子进程而不是线程，可以避免使用锁的情况，保证数据的安全性。

如果在重写过程中，主进程在持续接收客户端请求，新的命令会对数据库数据进行修改，这就使得重写后的AOF文件所保存的数据和数据库当前的状态不一致。
 
为了解决这个问题，Redis设置了一个AOF重写缓冲区，这个缓冲区存储着在AOF文件重写期间，主进程所接收到的命令，同时还会将这个写命令发送到AOF缓冲区。

在AOF重写期间，服务器进程需要执行以下三个工作：
1. 接收客户端命令
2. 将执行后的写命令追加到AOF缓冲区
3. 将执行后的写命令追加到AOF重写缓冲区。

可以保证：
- AOF缓冲区的内容会定时写入到AOF文件中，这是AOF文件的正常写入过程
- 从创建AOF重写子进程开始，服务器执行的所有命令会被记录在AOF重写缓冲区里

当子进程AOF重写工作后，会将AOF重写缓冲区的所有内容写入到新的AOF文件中。