## 主从模式
主从复制，是指将一台Redis服务器的数据，复制到其他的Redis服务器。前者称为主节点(Master)，后者称为从节点(Slave)；数据的复制是单向的，只能由主节点到从节点。

默认情况下，每台Redis服务器都是主节点；且一个主节点可以有多个从节点(或没有从节点)，但一个从节点只能有一个主节点。

### 主从复制作用
- 数据冗余：主从复制实现了数据的热备份，是持久化之外的一种数据冗余方式。
- 故障恢复：当主节点出现问题时，可以由从节点提供服务，实现快速的故障恢复；实际上是一种服务的冗余。
- 负载均衡：在主从复制的基础上，配合读写分离，可以由主节点提供写服务，由从节点提供读服务（即写Redis数据时应用连接主节点，读Redis数据时应用连接从节点），分担服务器负载；尤其是在写少读多的场景下，通过多个从节点分担读负载，可以大大提高Redis服务器的并发量。
- 高可用基石：除了上述作用以外，主从复制还是哨兵和集群能够实施的基础，因此说主从复制是Redis高可用的基础。

### 主从复制过程
1. 若启动一个Slave机器进程，则它会向Master机器发送一个“sync command”命令，请求同步连接。
2. 无论是第一次连接还是重新连接，Master机器都会启动一个后台进程，将数据快照保存到数据文件中（执行rdb操作），同时Master还会记录修改数据的所有命令并缓存在数据文件中。 
3. 后台进程完成缓存操作之后，Maste机器就会向Slave机器发送数据文件，Slave端机器将数据文件保存到硬盘上，然后将其加载到内存中，接着Master机器就会将修改数据的所有操作一并发送给Slave端机器。若Slave出现故障导致宕机，则恢复正常后会自动重新连接。
4. Master机器收到Slave端机器的连接后，将其完整的数据文件发送给Slave端机器，如果Mater同时收到多个Slave发来的同步请求，则Master会在后台启动一个进程以保存数据文件，然后将其发送给所有的Slave端机器，确保所有的Slave端机器都正常。

### 数据同步
#### 全量数据同步
1. 从数据库连接到主数据库
2. 从数据库发送ping命令，主数据库回复pong命令
发送ping主要是为了（相当于tcp的 keepalive 心跳包）检测主数据库是否有响应
3. 从数据库发送一个同步命令，主数据库进行异步发送数据
无论主数据采用aof还是rdb的持久化方式，在主从复制的时候都以rdb的数据格式进行复制
4. 从数据库根据rdb调整内存后，发送给主数据库完成同步命令

#### 增量数据同步
在从数据库连接着主数据库情况下，由于网络原因，某些数据出现主从不一致的情况，这时候可以容忍数据不一致的情况，通过设置环形缓冲区，将网络抖动时候的数据先写入环形缓冲区，从数据库会记录一个偏移值，在主数据库发送数据前，从数据库先把偏移值发送给主数据库，看偏移值是否在环形缓冲区中，然后再将环形缓冲区中偏移值到起始地址的数据发送到从数据库中

#### 服务器 RUN ID
1. 无论主库还是从库都有自己的 RUN ID，RUN ID 启动时自动产生，RUN ID 由40个随机的十六进制字符组成；
2. 当从库对主库初次复制时，主库将自身的 RUN ID 传送给从库，从库会将 RUN ID 保存；
3. 当从库断线重连主库时，从库将向主库发送之前保存的 RUN ID；
   - 从库 RUN ID 和主库 RUN ID 一致，说明从库断线前复制的就是当前的主库；主库尝试执行 增量同步操作；
   - 若不一致，说明从库断线前复制的主库并不时当前的主库，则主库将对从库执行全量同步操作；

#### 复制偏移量 offset
主从都会维护一个复制偏移量；
- 主库向从库发送N个字节的数据时，将自己的复制偏移量上加N；
- 从库接收到主库发送的N个字节数据时，将自己的复制偏移量加上N；

通过比较主从偏移量得知主从之间数据是否一致；偏移量相同则数据一致；偏移量不同则数据不一致；

#### 环形缓冲区
当因某些原因（网络抖动或从库宕机）从库与主库断开连接，避免重新连接后开始全量同步，在主库设置了一个环形缓冲区；该缓冲区会在从库失联期间累计主库的写操作；当从库重连，会发送自身的复制偏移量到主库，主库会比较主从的复制偏移量：
- 若从库offset还在复制积压缓冲区中，则进行增量同步；
- 否则，主库将对从库执行全量同步；

## 哨兵模式
哨兵(sentinel)：是一个分布式系统，用于对主从结构中的每台服务器进行监控，当出现故障时通过投票机制选择新的 Master 并将所有 Slave 连接到新的 Master。所以整个运行哨兵的集群的数量不得少于3个节点。

哨兵的启动依赖于主从模式，所以须把主从模式安装好的情况下再去做哨兵模式，所有节点上都需要部署哨兵模式，哨兵模式会监控所有的 Redis 工作节点是否正常，当 Master 出现问题的时候，因为其他节点与主节点失去联系，因此会投票，投票过半就认为这个 Master 的确出现问题，然后会通知哨兵间，然后从 Slaves 中选取一个作为新的 Master。

### 结构
- 哨兵节点：哨兵系统由一个或多个哨兵节点组成，哨兵节点是特殊的redis节点，不存储数据。
- 数据节点：主节点和从节点都是数据节点。

### 哨兵作用
- 监控：哨兵会不断地检查主节点和从节点是否运作正常。
- 自动故障转移：当主节点不能正常工作时，哨兵会开始自动故障转移操作，它会将失效主节点的其中一个从节点升级为新的主节点，并让其他从节点改为复制新的主节点。
- 通知（提醒）：哨兵可以将故障转移的结果发送给客户端。

哨兵和主数据库建立连接后会定时执行以下三个操作：
1. 每隔10s向主数据库和从数据库发送info命令：获取当前数据库信息，比如发现新增从节点时，会建立连接，并加入到监控列表中，当主从数据库的角色发生变化进行信息更新。
2. 每隔2s向主数据里和从数据库的_sentinel_:hello频道发送自己的信息：将自己的监控数据和哨兵分享，发送的内容为:
<哨兵地址>，<哨兵端口>，<哨兵运行id>，<哨兵配置版本>，<主数据库名字>，<主数据库地址>，<主数据库端口>，<主数据库配置版本>，每个哨兵会订阅数据库的_sentinel_:hello频道，当其他哨兵收到消息后，会判断该哨兵是不是新的哨兵，如果是则将其加入哨兵列表，并建立连接。
3. 每隔1s向所有数据库节点和所有哨兵节点发送ping命令：监控节点是否存活。该时间间隔有down-after-millisecond实现，当该值小于1s时，哨兵会按照设定的值发送ping，当大于1s时，哨兵会间隔1s发送ping命令。

#### 主从切换
当超过down-after-millisecond时间后，如果节点未回复，则哨兵认为主观下线。主观下线表示当前哨兵认为该节点已经下线，如果该节点为主数据库，哨兵会进一步判断是够需要对其进行故障恢复，这时候就要发送SENTINEL is-master-down-by-addr命令询问其他哨兵节点是否认为该主节点是主观下线，当达到指定数量时，哨兵就会认为是客观下线，该数量由sentinel monitor master-name ip port quorum的quorum参数设定。
 
当主节点客观下线时就需要进行主从切换，主从切换的步骤为：
1. 选出领头哨兵（Raft算法）
2. 领头哨兵从在线的从数据库中，选择优先级最高的从数据库。优先级可以通过slave-priority选项设置。
3. 如果优先级相同，则从复制的命令偏移量越大（即复同步数据越多，数据越新），越优先。
4. 如果以上条件都一样，则选择run ID较小的从数据库。

## 集群模式
### 结构
1. 所有的redis节点彼此互联(PING-PONG机制),内部使用二进制协议优化传输速度和带宽。
2. 节点的fail是通过集群中超过半数的节点检测失效时才生效。
3. 客户端与redis节点直连,不需要中间代理层.客户端不需要连接集群所有节点,连接集群中任何一个可用节点即可。

### 数据分区
数据分区（或称数据分片）是集群最核心的功能（分布式）。集群将数据分散到多个节点，一方面突破了 Redis 单机内存大小的限制，存储容量大大增加，另一方面每个主节点都可以对外提供读服务和写服务，大大提高了集群的响应能力
```
Redis 单机内存大小受限问题，在介绍持久化和主从复制时都有提及
例如，如果单机内存太大，bgsave 和 bgrewriteaof 的 fork 操作可能导致主进程阻塞，主从环境下主机切换时可能导致从节点长时间无法提供服务，全量复制阶段主节点的复制缓冲区可能溢出
```

### 高可用
集群支持主从复制（模式）和主节点的自动故障转移（与哨兵类似），当任意节点发送故障时，集群仍然可以对外提供服务

### 数据分片
Redis 集群引入了哈希槽的概念，有 16384 个哈希槽（编号 0~16383）
集群的每个节点负责一部分哈希槽，每个 Key 通过 CRC16 校验后对 16384 取余来决定放置哪个哈希槽，通过这个值，去找到对应的插槽所对应的节点，然后直接自动跳转到这个对应的节点上进行存取操作